<!DOCTYPE html>
<html>
  <head>
    <title>Video Call - Connect with Friends</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .container {
        width: 100%;
        max-width: 1200px;
      }

      .card {
        background: #ffffff;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }

      .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px 30px;
        text-align: center;
      }

      .card-header h1 {
        font-size: 1.8rem;
        margin-bottom: 5px;
      }

      .card-header p {
        font-size: 0.95rem;
        opacity: 0.9;
      }

      .content {
        padding: 30px;
      }

      .setup-screen, .call-screen {
        display: none;
      }

      .setup-screen.active, .call-screen.active {
        display: block;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 500;
      }

      .form-group input {
        width: 100%;
        padding: 15px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        font-size: 1rem;
        outline: none;
        transition: border-color 0.3s ease;
      }

      .form-group input:focus {
        border-color: #667eea;
      }

      .btn {
        padding: 15px 30px;
        border: none;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 10px;
      }

      .btn:hover {
        transform: translateY(-2px);
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-success {
        background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
        color: white;
      }

      .btn-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
      }

      .btn-secondary {
        background: #6b7280;
        color: white;
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .button-group {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
      }

      /* Video Grid */
      .video-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .video-container {
        position: relative;
        background: #1a1a2e;
        border-radius: 15px;
        overflow: hidden;
        aspect-ratio: 16/9;
      }

      .video-container video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .video-label {
        position: absolute;
        bottom: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 8px 15px;
        border-radius: 8px;
        font-size: 0.9rem;
      }

      .video-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: #666;
      }

      .video-placeholder svg {
        width: 60px;
        height: 60px;
        margin-bottom: 15px;
        opacity: 0.5;
      }

      /* Call Controls */
      .call-controls {
        display: flex;
        justify-content: center;
        gap: 15px;
        flex-wrap: wrap;
      }

      .control-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .control-btn:hover {
        transform: scale(1.1);
      }

      .control-btn svg {
        width: 24px;
        height: 24px;
      }

      .control-btn.active {
        background: #667eea;
        color: white;
      }

      .control-btn.inactive {
        background: #e9ecef;
        color: #333;
      }

      .control-btn.end-call {
        background: #ef4444;
        color: white;
        width: 70px;
        height: 70px;
      }

      .control-btn.end-call:hover {
        background: #dc2626;
      }

      /* Status */
      .status-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        background: #f8f9fa;
        border-radius: 10px;
        margin-bottom: 20px;
      }

      .status-item {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #16a34a;
        animation: pulse 2s infinite;
      }

      .status-dot.disconnected {
        background: #ef4444;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      /* Call Timer */
      .call-timer {
        text-align: center;
        font-size: 1.5rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 20px;
        font-family: monospace;
      }

      /* Waiting Screen */
      .waiting-screen {
        text-align: center;
        padding: 40px;
      }

      .waiting-screen h2 {
        color: #333;
        margin-bottom: 15px;
      }

      .waiting-screen p {
        color: #666;
        margin-bottom: 20px;
      }

      .room-code {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
      }

      .room-code h3 {
        color: #667eea;
        font-size: 2rem;
        letter-spacing: 5px;
        margin-bottom: 10px;
      }

      .room-code p {
        font-size: 0.9rem;
        margin-bottom: 15px;
      }

      /* Connection Status */
      .connection-status {
        text-align: center;
        padding: 20px;
        background: #fef3c7;
        border-radius: 10px;
        margin-bottom: 20px;
        color: #92400e;
      }

      .connection-status.connected {
        background: #dcfce7;
        color: #166534;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .video-grid {
          grid-template-columns: 1fr;
        }

        .button-group {
          flex-direction: column;
        }

        .btn {
          width: 100%;
          justify-content: center;
        }
      }

      /* Fullscreen mode */
      .fullscreen-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.5);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.85rem;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <div class="card-header">
          <h1>ðŸ“¹ Video Call</h1>
          <p>Connect with friends and family via video/voice call</p>
        </div>

        <div class="content">
          <!-- Setup Screen -->
          <div class="setup-screen active" id="setupScreen">
            <div class="form-group">
              <label>Your Name</label>
              <input type="text" id="userName" placeholder="Enter your name" maxlength="30">
            </div>

            <div class="button-group">
              <button class="btn btn-success" onclick="createRoom()">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                Create Room
              </button>
              <button class="btn btn-primary" onclick="showJoinScreen()">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                Join Room
              </button>
            </div>

            <!-- Join Form (hidden by default) -->
            <div id="joinForm" style="display: none; margin-top: 20px;">
              <div class="form-group">
                <label>Room Code</label>
                <input type="text" id="roomCodeInput" placeholder="Enter room code" maxlength="6" style="text-transform: uppercase; letter-spacing: 3px; text-align: center; font-size: 1.5rem;">
              </div>
              <div class="button-group">
                <button class="btn btn-primary" onclick="joinRoom()">Join Call</button>
                <button class="btn btn-secondary" onclick="hideJoinScreen()">Back</button>
              </div>
            </div>
          </div>

          <!-- Call Screen -->
          <div class="call-screen" id="callScreen">
            <!-- Waiting for peer -->
            <div id="waitingScreen" class="waiting-screen">
              <h2>Waiting for friend to join...</h2>
              <p>Share this room code with your friend:</p>
              <div class="room-code">
                <h3 id="roomCodeDisplay">------</h3>
                <p>Room Code</p>
              </div>
              <p>Or ask your friend for their room code and join their room.</p>
              <button class="btn btn-secondary" onclick="copyRoomCode()">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                Copy Code
              </button>
            </div>

            <!-- Active Call -->
            <div id="activeCall" style="display: none;">
              <div class="status-bar">
                <div class="status-item">
                  <span class="status-dot" id="connectionDot"></span>
                  <span id="connectionStatus">Connecting...</span>
                </div>
                <div class="status-item">
                  <span>Room: </span>
                  <strong id="currentRoomCode">------</strong>
                </div>
              </div>

              <div class="call-timer" id="callTimer">00:00</div>

              <div class="video-grid">
                <div class="video-container">
                  <video id="localVideo" autoplay muted playsinline></video>
                  <div class="video-label">You</div>
                  <button class="fullscreen-btn" onclick="toggleFullscreen('localVideo')">â›¶</button>
                </div>
                <div class="video-container">
                  <video id="remoteVideo" autoplay playsinline></video>
                  <div class="video-label" id="remoteLabel">Friend</div>
                  <div class="video-placeholder" id="remotePlaceholder" style="display: none;">
                    <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    <span>Waiting for video...</span>
                  </div>
                  <button class="fullscreen-btn" onclick="toggleFullscreen('remoteVideo')">â›¶</button>
                </div>
              </div>

              <div class="call-controls">
                <button class="control-btn active" id="micBtn" onclick="toggleMic()" title="Microphone">
                  <svg id="micIcon" fill="currentColor" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg>
                </button>
                <button class="control-btn active" id="cameraBtn" onclick="toggleCamera()" title="Camera">
                  <svg id="cameraIcon" fill="currentColor" viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>
                </button>
                <button class="control-btn end-call" onclick="endCall()" title="End Call">
                  <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7 0-.28.11-.53.29-.71C3.34 8.78 7.46 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.71l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28-.79-.74-1.69-1.36-2.67-1.85-.33-.16-.56-.5-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/></svg>
                </button>
              </div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
              <button class="btn btn-secondary" onclick="leaveRoom()">Leave Room</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- PeerJS for WebRTC signaling -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script>
      // Variables
      let peer = null;
      let currentCall = null;
      let localStream = null;
      let remoteStream = null;
      let isAudioEnabled = true;
      let isVideoEnabled = true;
      let callTimer = null;
      let callSeconds = 0;
      let roomCode = '';
      let userName = '';
      let isInitiator = false;
      let connections = [];

      // DOM Elements
      const setupScreen = document.getElementById('setupScreen');
      const callScreen = document.getElementById('callScreen');
      const waitingScreen = document.getElementById('waitingScreen');
      const activeCall = document.getElementById('activeCall');
      const joinForm = document.getElementById('joinForm');

      // Generate random room code
      function generateRoomCode() {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
        let code = '';
        for (let i = 0; i < 6; i++) {
          code += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return code;
      }

      // Create room and initialize PeerJS
      async function createRoom() {
        userName = document.getElementById('userName').value.trim();
        if (!userName) {
          alert('Please enter your name!');
          return;
        }

        roomCode = generateRoomCode();
        isInitiator = true;

        await initializePeer(roomCode);
        showCallScreen();
        startWaiting();
      }

      // Show join form
      function showJoinScreen() {
        joinForm.style.display = 'block';
      }

      // Hide join form
      function hideJoinScreen() {
        joinForm.style.display = 'none';
      }

      // Join existing room
      async function joinRoom() {
        userName = document.getElementById('userName').value.trim();
        const code = document.getElementById('roomCodeInput').value.trim().toUpperCase();

        if (!userName) {
          alert('Please enter your name!');
          return;
        }

        if (!code || code.length !== 6) {
          alert('Please enter a valid 6-character room code!');
          return;
        }

        roomCode = code;
        isInitiator = false;

        await initializePeer();
        showCallScreen();
        connectToPeer(roomCode);
      }

      // Initialize PeerJS
      async function initializePeer(customId = null) {
        return new Promise((resolve, reject) => {
          const peerId = customId || 'call-' + Math.random().toString(36).substr(2, 9);

          peer = new Peer(peerId, {
            debug: 2
          });

          peer.on('open', (id) => {
            console.log('PeerJS connected with ID:', id);
            resolve();
          });

          peer.on('error', (err) => {
            console.error('PeerJS error:', err);
            alert('Connection error: ' + err.type);
            reject(err);
          });

          peer.on('call', (call) => {
            handleIncomingCall(call);
          });

          peer.on('connection', (conn) => {
            handleDataConnection(conn);
          });
        });
      }

      // Handle incoming call
      async function handleIncomingCall(call) {
        console.log('Incoming call from:', call.peer);

        // Get local stream
        try {
          localStream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true
          });

          document.getElementById('localVideo').srcObject = localStream;

          // Answer the call
          call.answer(localStream);
          handleCall(call);

          // Hide waiting, show active call
          waitingScreen.style.display = 'none';
          activeCall.style.display = 'block';
          document.getElementById('remoteLabel').textContent = 'Friend';
        } catch (err) {
          console.error('Error accessing media devices:', err);
          alert('Could not access camera/microphone. Please allow permissions.');
        }
      }

      // Connect to peer
      async function connectToPeer(peerId) {
        try {
          // Get local stream first
          localStream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true
          });

          document.getElementById('localVideo').srcObject = localStream;

          // Call the peer
          const call = peer.call(peerId, localStream);
          handleCall(call);

          // Hide waiting, show active call
          waitingScreen.style.display = 'none';
          activeCall.style.display = 'block';
          document.getElementById('remoteLabel').textContent = 'Friend';
        } catch (err) {
          console.error('Error connecting to peer:', err);
          alert('Could not access camera/microphone. Please allow permissions.');
        }
      }

      // Handle established call
      function handleCall(call) {
        currentCall = call;

        call.on('stream', (stream) => {
          console.log('Received remote stream');
          remoteStream = stream;
          document.getElementById('remoteVideo').srcObject = stream;
          document.getElementById('remotePlaceholder').style.display = 'none';
          document.getElementById('remoteVideo').style.display = 'block';

          // Update connection status
          document.getElementById('connectionDot').classList.remove('disconnected');
          document.getElementById('connectionStatus').textContent = 'Connected';
          document.getElementById('connectionStatus').parentElement.querySelector('.connection-status').classList.add('connected');

          // Start timer
          startCallTimer();
        });

        call.on('close', () => {
          console.log('Call ended');
          endCall();
        });

        call.on('error', (err) => {
          console.error('Call error:', err);
        });
      }

      // Handle data connection
      function handleDataConnection(conn) {
        conn.on('data', (data) => {
          console.log('Received data:', data);
          if (data.type === 'userName') {
            document.getElementById('remoteLabel').textContent = data.name;
          }
        });

        connections.push(conn);
      }

      // Show call screen
      function showCallScreen() {
        setupScreen.classList.remove('active');
        callScreen.classList.add('active');
        document.getElementById('currentRoomCode').textContent = roomCode;
      }

      // Start waiting screen
      function startWaiting() {
        waitingScreen.style.display = 'block';
        activeCall.style.display = 'none';
        document.getElementById('roomCodeDisplay').textContent = roomCode;

        // Get local stream for preview
        navigator.mediaDevices.getUserMedia({
          video: true,
          audio: true
        }).then(stream => {
          localStream = stream;
          document.getElementById('localVideo').srcObject = stream;
        }).catch(err => {
          console.error('Error accessing media:', err);
        });
      }

      // Copy room code
      function copyRoomCode() {
        navigator.clipboard.writeText(roomCode).then(() => {
          alert('Room code copied: ' + roomCode);
        }).catch(() => {
          prompt('Copy this room code:', roomCode);
        });
      }

      // Toggle microphone
      function toggleMic() {
        if (localStream) {
          const audioTrack = localStream.getAudioTracks()[0];
          if (audioTrack) {
            isAudioEnabled = !isAudioEnabled;
            audioTrack.enabled = isAudioEnabled;
            document.getElementById('micBtn').classList.toggle('active', isAudioEnabled);
            document.getElementById('micIcon').innerHTML = isAudioEnabled
              ? '<path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/>'
              : '<path d="M19 11h-1.7c0 .74-.16 1.43-.43 2.05l1.23 1.23c.56-.98.9-2.09.9-3.28zm-4.02.17c0-.06.02-.11.02-.17V5c0-1.66-1.34-3-3-3S9 3.34 9 5v.18l5.98 5.99zM4.27 3L3 4.27l6.01 6.01V11c0 1.66 1.33 3 2.99 3 .22 0 .44-.03.65-.08l1.66 1.66c-.71.33-1.5.52-2.31.52-2.76 0-5.3-2.1-5.3-5.1H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c.91-.13 1.77-.45 2.54-.9L19.73 21 21 19.73 4.27 3z"/>';
          }
        }
      }

      // Toggle camera
      function toggleCamera() {
        if (localStream) {
          const videoTrack = localStream.getVideoTracks()[0];
          if (videoTrack) {
            isVideoEnabled = !isVideoEnabled;
            videoTrack.enabled = isVideoEnabled;
            document.getElementById('cameraBtn').classList.toggle('active', isVideoEnabled);
            document.getElementById('localVideo').style.display = isVideoEnabled ? 'block' : 'none';
          }
        }
      }

      // End call
      function endCall() {
        if (currentCall) {
          currentCall.close();
        }

        stopCallTimer();

        // Show waiting screen again
        waitingScreen.style.display = 'block';
        activeCall.style.display = 'none';

        // Reset UI
        document.getElementById('remoteVideo').srcObject = null;
        document.getElementById('remotePlaceholder').style.display = 'flex';
        document.getElementById('connectionDot').classList.add('disconnected');
        document.getElementById('connectionStatus').textContent = 'Disconnected';

        currentCall = null;
        remoteStream = null;

        // If initiator, stay in room. If joiner, show alert
        if (!isInitiator) {
          alert('Call ended. The host may still be waiting for others.');
        }
      }

      // Leave room
      function leaveRoom() {
        if (localStream) {
          localStream.getTracks().forEach(track => track.stop());
          localStream = null;
        }

        if (peer) {
          peer.destroy();
          peer = null;
        }

        stopCallTimer();

        // Reset UI
        setupScreen.classList.add('active');
        callScreen.classList.remove('active');
        joinForm.style.display = 'none';
        waitingScreen.style.display = 'block';
        activeCall.style.display = 'none';

        // Reset video elements
        document.getElementById('localVideo').srcObject = null;
        document.getElementById('remoteVideo').srcObject = null;
        document.getElementById('connectionDot').classList.add('disconnected');
        document.getElementById('connectionStatus').textContent = 'Disconnected';

        // Reset controls
        isAudioEnabled = true;
        isVideoEnabled = true;
        document.getElementById('micBtn').classList.add('active');
        document.getElementById('cameraBtn').classList.add('active');

        connections = [];
        roomCode = '';
      }

      // Call timer
      function startCallTimer() {
        callSeconds = 0;
        if (callTimer) clearInterval(callTimer);
        callTimer = setInterval(() => {
          callSeconds++;
          const mins = Math.floor(callSeconds / 60).toString().padStart(2, '0');
          const secs = (callSeconds % 60).toString().padStart(2, '0');
          document.getElementById('callTimer').textContent = `${mins}:${secs}`;
        }, 1000);
      }

      function stopCallTimer() {
        if (callTimer) {
          clearInterval(callTimer);
          callTimer = null;
        }
        callSeconds = 0;
        document.getElementById('callTimer').textContent = '00:00';
      }

      // Fullscreen toggle
      function toggleFullscreen(videoId) {
        const video = document.getElementById(videoId);
        const container = video.parentElement;

        if (document.fullscreenElement) {
          document.exitFullscreen();
        } else {
          container.requestFullscreen();
        }
      }

      // Load saved username
      const savedName = localStorage.getItem('callUserName');
      if (savedName) {
        document.getElementById('userName').value = savedName;
      }

      document.getElementById('userName').addEventListener('change', function() {
        localStorage.setItem('callUserName', this.value);
      });
    </script>
  </body>
</html>

